---
title: "Getting Started with MiteMapTools"
author: "Adrien Taudière and Lise Roy"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with MiteMapTools}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "figures/",
  out.width = "100%",
  dpi = 150,
  fig.width = 7,
  fig.height = 5
)
```

# Introduction

MiteMapTools is a comprehensive R package for importing, analyzing, and visualizing movement data from MiteMap tracking systems. MiteMap is a cost-effective, open-source tool for 2D behavioral tracking of arthropods, particularly useful for studying chemotactic responses and movement patterns in controlled laboratory settings.

## About MiteMap

MiteMap is a Raspberry Pi-based automated tracking system designed to monitor arthropod behavior in circular arenas. The system uses infrared imaging to track individual organisms with high temporal resolution (position recorded every 0.2 seconds) and spatial precision. This technology enables researchers to study:

- **Chemotactic behavior**: How arthropods respond to attractive or repulsive volatile compounds
- **Movement patterns**: Analysis of trajectory complexity, speed, and spatial preferences  
- **Zone preferences**: Time allocation between different arena regions
- **Behavioral states**: Periods of activity vs. immobility

The system consists of a circular arena (typically 40mm diameter) where test subjects are placed with potential stimuli positioned at the arena periphery. High-resolution tracking data allows for detailed quantitative analysis of behavioral responses. The original MiteMap hardware and software can be found at: <https://github.com/LR69/MiteMap/tree/MiteMap.v6>

## Scientific Background

This package implements methods described in:

**Masier, L.‐S., Roy, L., & Durand, J.‐F. (2022). A new methodology for arthropod behavioral assays using MiteMap, a cost‐effective open‐source tool for 2D tracking. Journal of Experimental Zoology Part A: Ecological and Integrative Physiology, 337(4), 333-344.** [doi:10.1002/jez.2651](https://onlinelibrary.wiley.com/doi/10.1002/jez.2651)



# Installation

You can install the development version of MiteMapTools from GitHub with:

```{r eval=FALSE}
# install.packages("pak")
pak::pak("adrientaudiere/MiteMapTools")
```

# Basic Usage

Let's start by loading the package and exploring the example dataset:

```{r setup}
library(MiteMapTools)
```

## Data Import and Basic Visualization

The main function for importing MiteMap data is `import_mitemap()`. For this tutorial, we'll use both the built-in example dataset and demonstrate how to import data from files.

### Using Built-in Example Data

The package includes a pre-processed example dataset:

```{r load-data}
# Load the built-in example dataset
data(MM_data)

# Examine the structure of the data
head(MM_data)

glimpse(MM_data)
```

### Importing Data from Files

For your own data, you would import from MiteMap output files:

```{r example-import, eval=FALSE}
MM <- import_mitemap(
  system.file("extdata", "mitemap_example", package = "MiteMapTools"),
  file_name_column = "File (mite ID)",
  verbose = FALSE,
  clean = TRUE
)
```

For the rest of this tutorial, we'll use the built-in `MM_data` dataset.

```{r assign-data}
# Use the built-in data for examples
MM <- MM_data
```

## Creating Violin Plots

One of the key visualization functions is `vioplot_mitemap()`, which shows position distributions by experimental condition:

```{r violin-plot}
# Create violin plots showing position distributions by experimental condition
vioplot_mitemap(MM, "Treatment", prop_points = 0.1)
```

This plot shows how different treatments affect the distribution of organism positions along the x-axis (with the odor source typically positioned at x = -20mm and y = 0mm).

## Individual Trajectory Plotting

To visualize individual movement trajectories, use `plot_ind_mitemap()`:

```{r individual-plots}
# Plot individual trajectories for the first two organisms
library(patchwork) # for combining plots

# Get individual plots
p_list <- plot_ind_mitemap(MM, ind_index = c(1, 2))

# Combine plots side by side
p_list[[1]] + p_list[[2]] & theme(legend.position = "none")
```

You can also add arena context:

```{r individual-plots-with-arena}
# Plot with arena circle and odor source
p_arena <- plot_ind_mitemap(
  MM,
  ind_index = 1,
  add_base_circle = TRUE,
  linewidth = 1.7,
  label_odor_source = "Odor source"
)

p_arena[[1]]
```

## Data Structure Requirements

For your own experiments, a MiteMap experiment folder should contain:

**1. Zip archives** containing at least 2 files:
   - **Raw data CSV**: 3-column tracking data (Time in seconds, X position in mm, Y position in mm)
   - **PNG heatmap**: Visual representation of movement patterns

**2. Metadata file** (Excel .xlsx or CSV format, optional) with 1 required column:
   - **File_name**: Must match the corresponding zip file names

You can use a different column name with the `file_name_column` parameter in `import_mitemap()`.

## Arena Layout and Zone Definitions

The arena is divided into different zones for analysis:

### HH Format (Half-Half)
- Arena divided by a line through the odor source
- Computes time spent in each half, distance traveled, and immobility time

### CH Format (Circle-Half)  
- Arena divided by a circle centered on the odor source
- Encompasses half the arena surface
- Analyzes time spent inside/outside the circle and behavioral preference indices

```{r arena-diagram, echo=FALSE}
circleFun <- function(center = c(0, 0), diameter = 1, npoints = 100) {
  r <- diameter / 2
  tt <- seq(0, 2 * pi, length.out = npoints)
  xx <- center[1] + r * cos(tt)
  yy <- center[2] + r * sin(tt)
  return(data.frame(x = xx, y = yy))
}

dat <- circleFun(c(0, 0), 40, npoints = 1000)
dat_C_interm <- circleFun(c(-20, 0), (26.0714 * 40 / 22.5), npoints = 1000)

# compute value of intersection (-6.57, 18.89) https://planetcalc.com/8098/
dat_C <- dat_C_interm[dat_C_interm$x > -6.57, ]
dat_C2 <- dat[dat$x < -6.57, ]
dat_C <- rbind(dat_C, dat_C2)


ggplot(dat, aes(x, y)) +
  geom_path() +
  coord_fixed() +
  theme_minimal() +
  geom_vline(xintercept = 0) +
  geom_polygon(data = mutate(dat, x = ifelse(x > 0, 0, x)), fill = "green") +
  geom_polygon(data = dat_C, fill = "blue", alpha = 0.4) +
  geom_point(x = -19.5, y = 0, size = 7, shape = 8, color = "red") +
  geom_label(x = -14, y = 0, label = "Odor source", color = "red") +
  geom_label(x = 5, y = 0, label = "CH shape", color = "blue", hjust = 0) +
  geom_label(x = 1, y = 18, label = "HH shape", color = "green", hjust = 0) +
  xlab("x (in mm)") +
  ylab("y (in mm)")
```

## Statistical Analysis

### Summarise statistics at the run level 

```{r summarise-runs}
# Summarise statistics at the run level
MM_summary <- suppressWarnings(summarize_mitemap(MM))
glimpse(MM_summary)
```

```{r}
MM_summary |>
  filter(Biomol_sp %in% c("DGL1", "DGSS", "D_carpathicus")) |>
  ggplot(aes(x = Treatment, y = in_left_half_CH_prop_TRUE, col = Treatment)) +
  geom_boxplot() +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "grey") +
  theme_minimal() +
  labs(
    title = "CH Preference for left side vs Treatment",
    y = "Proportion of run more in left side",
    x = "Treatment"
  ) +
  facet_wrap(~Biomol_sp)
```


```{r}
MM_summary |>
  filter(turning_angle_mean < 20 & turning_angle_mean > -20) |>
  ggplot(aes(x = Treatment, y = turning_angle_mean, col = Treatment)) +
  geom_boxplot() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  theme_minimal() +
  labs(
    title = "CH Preference for left side vs Treatment",
    y = "Turning angle",
    x = "Treatment"
  )
```

### Binomial Tests for Zone Preferences

Test whether organisms show significant preferences for specific zones:

```{r binomial-tests}
# Test zone preferences by treatment
binom_results <- binom_test_mitemap(MM, factor = "Treatment")
print(binom_results)
```

### Movement Metrics and Convex Hull Analysis

Calculate movement characteristics using convex hull analysis:

```{r convex-hull}
# Calculate convex hull metrics (spatial usage)
ch_results <- convex_hull_mitemap(MM, plot_show = FALSE, verbose = FALSE)
head(ch_results)

# Combine with metadata for analysis
library(dplyr)
combined_data <- full_join(ch_results, MM)

# Visualize hull area by treatment
library(ggplot2)
combined_data %>%
  ggplot(aes(x = Treatment, y = hull_area)) +
  geom_boxplot() +
  theme_minimal() +
  labs(
    title = "Spatial Usage (Convex Hull Area) by Treatment",
    y = "Hull Area (mm²)"
  )
```

## Data Filtering and Processing

The `filter_mitemap()` function allows you to clean and process the tracking data. Note that 
this is done automatically with clean=TRUE in [import_mitemap()], but you can 

```{r filtering}
# Apply custom filtering
MM_filtered <- filter_mitemap(
  MM,
  first_seconds_to_delete = 10,
  max_x_value = 20,
  min_x_value = -20,
  max_y_value = 20,
  min_y_value = -20
)

# Compare data sizes
cat("Original data points:", nrow(MM), "\n")
cat("Filtered data points:", nrow(MM_filtered), "\n")
```

## Advanced Visualizations

### Movement Speed Analysis

Analyze movement speeds and create speed-colored trajectory plots:

```{r speed-analysis}
# Create trajectory plots colored by movement speed
p_speed <- plot_ind_mitemap(
  MM,
  ind_index = 1:4,
  linewidth = 1.5
)

p_speed[[1]]

# Combine multiple speed plots
((p_speed[[1]] + p_speed[[2]]) / (p_speed[[3]] + p_speed[[4]])) +
  plot_layout(guides = "collect") & theme(legend.position = "none") &
  scale_color_viridis_c(name = "Speed\n(mm/s)", trans = "log1p")
```

# Summary

This vignette has introduced you to the basic functionality of MiteMapTools:

1. **Data Import**: Use `import_mitemap()` to load tracking data and metadata
2. **Visualization**: Create violin plots with `vioplot_mitemap()` and trajectory plots with `plot_ind_mitemap()`
3. **Statistical Analysis**: Perform zone preference tests with `binom_test_mitemap()`
4. **Movement Analysis**: Calculate spatial metrics with `convex_hull_mitemap()`
5. **Data Processing**: Filter and clean data with `filter_mitemap()`

For more detailed information about specific functions, please refer to their individual help pages using `?function_name` or browse the [reference documentation](https://adrientaudiere.github.io/MiteMapTools/reference/).

# Further Reading

- [Package Reference](https://adrientaudiere.github.io/MiteMapTools/reference/): Complete function documentation
- [Masier et al. (2022)](https://onlinelibrary.wiley.com/doi/10.1002/jez.2651): Original methodology paper
- [MiteMap Hardware](https://github.com/LR69/MiteMap/tree/MiteMap.v6): Hardware implementation details
